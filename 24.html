<!DOCTYPE html>
<html lang='en'>
  <head>
    <title>24!</title>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <link rel='preconnect' href='https://fonts.googleapis.com'>
    <link rel='preconnect' href='https://fonts.gstatic.com' crossorigin>
    <link href='https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap' rel='stylesheet'>
    <link href='https://fonts.googleapis.com/css2?family=Montserrat:wght@100..900&display=swap' rel='stylesheet'>
    <style>
        * {
            box-sizing: border-box;
            font-family: Montserrat;
            outline-color: #fdcc67;
        }
        *:not(h1) {
            font-weight: 600;
        }
        .row, .col { display: flex; }
        .row { flex-direction: row; }
        .col { flex-direction: column; }
        .mainStart { justify-content: start; }
        .mainCenter { justify-content: center; }
        .mainEnd { justify-content: end; }
        .spaceBetween { justify-content: end; }
        .crossStart { align-items: start; }
        .crossCenter { align-items: center; }
        .crossEnd { align-items: end; }
        body {
            margin: 0;
            font-size: 16px;
            background: black;
            color: white;
        }
        body, html, .page {
            height: 100%;
        }
        #joinLobbyInput {
            width: 100%;
            text-align: center;
            background: transparent;
            border: 2px solid #dbe0ff;
            border-radius: 4px;
            padding: 0.7rem 1rem;
            font-size: inherit;
            transition: border 150ms ease-in-out;
        }
        #joinLobbyInput:focus {
            border: 2px solid #8e9efe;
            outline: none;
        }
        #joinLobbyInput::placeholder {
            color: #b5c0ff;
        }
        .centeredStrip {
            max-width: 384px;
            margin: 0 auto;
            padding: 24px;
        }
        .centeredStrip::before, .centeredStrip::after {
            content: '. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .  . . . . . . . . . . . . . . . . . . . . . . . .';
            visibility: hidden;
        }
        h1 {
            color: white;
            font-size: 64px;
            margin: 0;
            text-align: center;
            text-shadow: 0 1px 16px rgb(255 255 255 / 20%);
        }
        .formBox {
            gap: 12px;
            padding: 16px;
            border-radius: 4px;
            box-shadow: 0 0 10px rgb(0 0 0 / 20%);
            background: white;
        }
        button {
            cursor: pointer;
            border: none;
            border-radius: 4px;
            width: 100%;
            font-size: inherit;
            padding: 0.7rem 1rem;
            color: #d4e6ff;
            color: white;
            background: #8e9efe;
        }
        button:hover {
            background: #ffde9c;
            background: #fdcc67;
        }
        .box, .operator {
            aspect-ratio: 1;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 2px;
        }
        .box {
            font-size: 48px;
            color: lime;
            border: 2px solid lime;
            box-shadow: 0 0 10px rgb(0 255 0 / 20%), inset 0 0 10px rgb(0 255 0 / 20%);
        }
        .operator {
            font-size: 48px;
            color: red;
            border: 2px solid red;
            box-shadow: 0 0 10px rgb(255 0 0 / 20%), inset 0 0 10px rgb(255 0 0 / 20%);
        }
    </style>
  </head>
  <body>
    <div id='loadingPage' class='page'>
      Connecting to server...
    </div>
    <div id='homePage' class='page col mainCenter crossCenter' style='display: none;'>
        <div class='centeredStrip'>
            <h1 style='padding-bottom:16px;'>24!</h1>
            <div class='formBox col mainStart crossCenter'>
                <input id='joinLobbyInput' placeholder='Game ID' autocomplete='off'>
                <button id='joinLobby'>Join game</button>
                <div class='row mainCenter crossCenter' style='width:100%; gap:4px; color:#dbe0ff; font-size:12px;'>
                    <div style='border-bottom:2px solid currentColor; flex-grow:1;'></div>
                    <div>OR</div>
                    <div style='border-bottom:2px solid currentColor; flex-grow:1;'></div>
                </div>
                <button id='createLobby'>Create game</button>
            </div>
        </div>
    </div>
    <div id='lobbyPage' class='page' style='display: none;'>
        <h1>Waiting for players to join</h1>
        <p>Your game id is <span class='lobbyId'></span></p>
        <div class='requiresHost'>
            <p>You are the host</p>
            <button id='startLobby'>Start game</button>
        </div>
        <a class='leaveLobby'>Leave</a>
    </div>
    <div id='solvePage' class='page col crossCenter' style='display: none;'>
        <div class='centeredStrip'>
            <h1>Solve Page</h1>
            <p>Game ID: <span class='lobbyId'></span></p>
            <div class='requiresHost'>
                <p>You are the host</p>
                <button id='startLobby'>Skip</button>
            </div>
            <div class='col' style='gap:4px;'>
                <div class='row' style='gap:4px;'><div class='box'></div><div class='box'></div></div>
                <div class='row' style='gap:4px;'><div class='box'></div><div class='box'></div></div>
                <div class='row' style='gap:4px;'>
                    <div class='operator'>+</div>
                    <div class='operator'>-</div>
                    <div class='operator'>×</div>
                    <div class='operator'>/</div>
                </div>
            </div>
            <a class='leaveLobby'>Leave</a>
        </div>
    </div>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js'></script>
    <script src='https://cdn.jsdelivr.net/gh/socketio/socket.io@4.4.1/client-dist/socket.io.min.js'></script>
    <script>
        class Fraction {
            constructor(n, d = 1) {
                if (d == 0) throw 'Denominator cannot be zero';
                if (d < 0) {
                    n = -n;
                    d = -d;
                }
                this.n = n;
                this.d = d;
                this.simplify();
            }
            simplify() {
                let f = Fraction.gcd(this.n, this.d);
                this.n /= f;
                this.d /= f;
            }
            static gcd(a, b) {
                a = Math.abs(a), b = Math.abs(b);
                if (b == 0) return a;
                return Fraction.gcd(b, a%b);
            }
            merge(other, op) {
                switch (op) {
                    case '+': return this.add(other);
                    case '-': return this.sub(other);
                    case '×': return this.mul(other);
                    case '/': return this.div(other);
                }
                throw 'Invalid operator in combine';
            }
            toString = () => this.d == 1 ? `${this.n}` : `${this.n}/${this.d}`;
            mul = other => new Fraction(this.n*other.n, this.d*other.d);
            div = other => new Fraction(this.n*other.d, this.d*other.n);
            add = other => new Fraction(this.n*other.d+other.n*this.d, this.d*other.d);
            sub = other => new Fraction(this.n*other.d-other.n*this.d, this.d*other.d);
            equals = other => this.n == other.n && this.d == other.d;
            equals24 = () => this.equals(new Fraction(24));
        }

        // const socket = io('wss://kamiak-io.fly.dev', {path: '/24/socket.io', query: 'id='+location.hash.substr(1)});
        // const socket = io('ws://localhost:8000', {path: '/24/socket.io', query: 'id='+location.hash.substr(1)});
        const socket = io(location.origin+':8000', {path: '/24/socket.io', query: 'id='+location.hash.substr(1)});
        socket.io.on('reconnect_error', () => socket.io.uri = 'wss://io.kamiak.org');

        let lobby;
        let numberHash = -1;

        function switchToPage(pageName) {
            $('.page').hide();
            $(`#${pageName}Page`).show();
        }
        switchToPage('loading');

        function updateLobby(newLobby) {
            if (newLobby !== undefined) lobby = newLobby;
            if (!lobby && socket.disconnected) {
                switchToPage('loading');
                return;
            }
            if (!lobby && socket.connected) {
                switchToPage('home');
                return;
            }
            $('.requiresHost').css('display', isLobbyHost() ? '' : 'none');
            $('.lobbyId').text(lobby.lobby_id);
            if (!lobby.started) {
                switchToPage('lobby');
                return;
            }
            if (!('solutions' in lobby)) {
                switchToPage('solve');
                return;
            }
        }
        updateLobby(null);

        function isLobbyHost() {
            if (!lobby) return false;
            return socket.id == lobby.users[0];
        }

        // function hashNumbers(numbers) {
        //     console.log(numbers);
        //     let hash = 0;
        //     for (let i = 0; i < numbers.length; ++i) {
        //         hash = hash*13+numbers[i]-1;
        //     }
        //     return hash;
        // }

        function refreshNumbers() {
            // console.log(hashNumbers(lobby.numbers));
            // if (numberHash == hashNumbers(lobby.numbers)) return;
            // numberHash = hashNumbers(lobby.numbers);
            $('.box').each(function (i) {
                $(this).text(numbers[i]);
            });
        }

        $('#createLobby').on('click', () => {
            socket.emit('create_lobby', () => {
                console.log(lobby);
                $('#joinLobbyInput').val('');
            });
        });

        $('#joinLobby').on('click', () => {
            inputLobbyId = $('#joinLobbyInput').val().trim().toLowerCase();
            if (!inputLobbyId) return;
            socket.emit('join_lobby', {lobby_id: inputLobbyId}, () => {
                if (lobby) {
                    $('#joinLobbyInput').val('');
                    return;
                }
                // Game ID not found
            });
        });

        $('.leaveLobby').on('click', () => {
            socket.emit('leave_lobby', {lobby_id: lobby.lobby_id});
            updateLobby(null);
        });

        $('#startLobby').on('click', () => {
            socket.emit('start_lobby', {lobby_id: lobby.lobby_id});
        });
       

        socket.on('connect', () => {
            console.log('connected');
            updateLobby();
            if (window.history.replaceState) {
                window.history.replaceState({}, null, location.origin+location.pathname);
            }
        });

        socket.on('disconnect', () => {
            console.log('disconnected');
            updateLobby(null);
        });

        socket.on('update_lobby', (data) => {
            updateLobby(data.lobby);
            if (lobby.numbers) refreshNumbers();
        });
        
    </script>
  </body>
</html>