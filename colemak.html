<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Colemak</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato&display=swap" rel="stylesheet">
    <style>
      #textbox {
        /* Fullscreen */
        width: calc(100% - 160px);
        height: calc(100vh - 160px);
        border: none;
        outline: none;
        resize: none;
        /* Looks */
        padding: 80px;
        font-family: Lato, Sans-Serif;
        font-size: 18px;
      }
    </style>
  </head>
  <body style="margin:0; overflow:hidden;">
    <textarea id="textbox" type="text" spellcheck="false"></textarea>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
      const         qwerty = 'qwertyuiopasdfghjkl;zxcvbnmQWERTYUIOPASDFGHJKL:ZXCVBNM';
      const colemakNoShift = 'qwfpgjluy;arstdhneiozxcvbkmqwfpgjluy;arstdhneiozxcvbkm';
      const   colemakShift = 'QWFPGJLUY:ARSTDHNEIOZXCVBKMQWFPGJLUY:ARSTDHNEIOZXCVBKM';
      const wordBreakers = ' \t\n!@#$%^&*;:,.?<>()[]{}-+=/\\|\'"';
      const textbox = document.getElementById('textbox');
      function storeText() { setTimeout(() => { localStorage.text = textbox.value }, 5) }
      textbox.value = localStorage.text || (localStorage.text = '');
      textbox.onkeydown = function (e) {
        console.log(e);

        if (e.key == 'CapsLock') {
          e.preventDefault();
          const start = this.selectionStart;
          const end = this.selectionEnd;
          if (start != end) {
            this.value = this.value.substring(0, start) + this.value.substring(end);
            this.selectionStart = this.selectionEnd = start;
          } else if (e.ctrlKey) {  // CTRL+BACKSPACE
            var i = start-1;  // Letter stopped, must delete at least one letter
            for (;i > 0 && wordBreakers.includes(this.value[i]); --i);  // First skip all immediate symbols
            for (;i > 0 && !wordBreakers.includes(this.value[i-1]); --i);  // Decrease until previous character is a symbol
            this.value = this.value.substring(0, i) + this.value.substring(end);
            this.selectionStart = this.selectionEnd = i;
          } else {
            this.value = this.value.substring(0, start-1) + this.value.substring(end);
            this.selectionStart = this.selectionEnd = start-1;
          }
          return;

        } else {

          if (e.altKey || e.ctrlKey || e.metaKey) return;

          var i;
          if (e.key.length == 1 && (i=qwerty.indexOf(e.key)) != -1 || e.key == 'Tab') {  // Insert key or tab
            e.preventDefault();
            const mappedKey = (e.key == 'Tab')?('\t'):(e.shiftKey?colemakShift[i]:colemakNoShift[i]);
            const start = this.selectionStart;
            const end = this.selectionEnd;
            this.value = this.value.substring(0, start) + mappedKey + this.value.substring(end);
            this.selectionStart = this.selectionEnd = start+1;
          }

          // TO BE ADDED!!!!!!!!!!!!!!! ALSO USE spellcheck="false" while typing to stop popping of error squiggles
          // ON CTRL+C COPY ENTIRE DOC IF NOTHING SELECTED
          // ALSO IMPORTANT: ADD CTRL Z
          // ALSO IMPORTANT: MAKE APP AVAILABLE OFFLINE

        }
        storeText();  // Textarea has not been modified yet
      }
      textbox.onpaste = function (e) {  // don't need this but i'll leave as ref for copy (see line 71)
        console.log('paste');
        // navigator.clipboard.writeText('t');
        storeText();  // Textarea has not been added yet
      }
    </script>
  </body>
</html>
